<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>DEMO</title>
    <style media="screen">
      #demo-element {
        width: 400px;
      }
      body {
        overflow:hidden;
        height: 100vh;
        display: flex;
        justify-content: center;
      }

      li {
        background-color: white;
        border: 1px solid whitesmoke;
        font-size: 2em;
        padding: 30px;
        box-shadow: 0 5px 20px 0 #EEE;
        border-radius: 20px;
        margin: 1em 0;
        list-style-type: none;

        /*transition: transform 100ms linear;*/
      }
    </style>
  </head>
  <body>
    <ul id="demo-element">
      <li>Item 1</li>
      <li>Item 2</li>
      <li>Item 3</li>
      <li>Item 4</li>
      <li>Item 5</li>
      Some reference text.
      <li>Item 6</li>
      <li>Item 7</li>
      <li>Item 8</li>
      <li>Item 9</li>
      <li>Item 10</li>
      <li>Item 11</li>
      <li>Item 12</li>
      <li>Item 13</li>
      <li>Item 14</li>
      <li>Item 15</li>
      <li>Item 16</li>
      <li>Item 17</li>
      <li>Item 18</li>
      <li>Item 19</li>
      <li>Item 20</li>
      <li>Item 21</li>
      <li>Item 22</li>
      Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
      <li>Item 23</li>
      <li>Item 24</li>
      <li>Item 25</li>
      <li>Item 26</li>
      <li>Item 27</li>
      <li>Item 28</li>
      <li>Item 29</li>
      <li>Item 30</li>
      <li>Item 31</li>
      <li>Item 32</li>
      <li>Item 33</li>
      <li>Item 34</li>
      <li>Item 35</li>
      <li>Item 36</li>
      <li>Item 37</li>
      <li>Item 38</li>
      <li>Item 39</li>
      <li>Item 40</li>
      <li>Item 41</li>
      <li>Item 42</li>
      <li>Item 43</li>
      <li>Item 44</li>
      <li>Item 45</li>
      <li>Item 46</li>
      <li>Item 47</li>
      <li>Item 48</li>
      <li>Item 49</li>
      <li>Item 50</li>
    </ul>

    <script src="tweenjs.js"></script>
    <script type="text/javascript">
      /** TODO
      * Implement bounce effect
      * Implement sluggish-effect on list elements
      * Add more input types (not only wheel)
      * Implement scroll bar

      * The core library should be as light as possible
      */

      // IDEA: Add velocity stack that gets dismantled over time. This could make acceleration very smooth (currently it is a bit junky)
      var box = document.getElementById("demo-element");
      var boxOffsetTop = 0;
      var boxChildren = document.getElementsByTagName("li")
      var data = [];
      var speed = 0; // in px/millisecond
      var friction = 0.0040; // in px/millisecond
      var totalDistance = 0;
      var isRunning = false;

      var frameTimeDelta = 0;
      var lastFrameTimeStamp = 0;
      var topViewportIndex = 0

      var syncPuffer = 0;

      var BOUNCE_THRESHOLD = 100;
      var MAX_SPEED = 4;

      {
        let length = boxChildren.length;
        for (var i = 0; i < length; i++) {
          data[i] = {
            offset: 0
          };
        }
      }

      function updateTopViewportElem () {
        let length = boxChildren.length;
        for (let i = 0; i < length; i++) {
          if (boxChildren[i].offsetTop > -totalDistance) {
            topViewportIndex = i;
            syncPuffer = data[i].offset;
            break;
          }
        }
      }

      function move (e) {
        // flip input (because it's the wrong way around)
        let deltaY = e.deltaY * -1;

        // Minimum speed to ensure snappy movement
        if (speed < 0.5 && speed > -0.5) {
          speed += deltaY/7;
        }
        else {
          speed += deltaY/15;
        }
        // Maximum speed limit
        if (speed > MAX_SPEED || speed < -MAX_SPEED) {
          speed = MAX_SPEED * Math.sign(speed);
        }

        updateTopViewportElem();
        // IDEA: Maybe there could be a AddMovemnt function (if things get more complex?)

        if (isRunning == false) {
          lastFrameTimeStamp = performance.now();
          isRunning = true;
          requestAnimationFrame(animate);
        }
      }

      function getDelta(timePassed) {
        // NOTE: This does not take into account all speed steps that may happen
        // during a long frame, so this is not always accurate
        return timePassed * speed;
      }
      function animate() {
        var currentFrameTimeStamp = performance.now();
        var frameTimeDelta = Math.floor(currentFrameTimeStamp - lastFrameTimeStamp);
        let length = boxChildren.length;

        lastFrameTimeStamp = currentFrameTimeStamp;

        if (speed != 0) {
          requestAnimationFrame(animate);

          for (var i = 0; i < length; i++) {
            boxChildren[i]
          }

          box.style.transform = `translateY(${totalDistance += getDelta(frameTimeDelta)}px)`;

          // NOTE: The following could be prettier (and more performant?)
          //       Maybe we could keep a variable that has speed's current sign
          // BUG: On Webkit/Blink browsers speed is WAY to fast
          speed = Math.sign(speed)==-1 ? Math.min(speed + friction * frameTimeDelta, 0) : Math.max(speed - friction * frameTimeDelta, 0);
          if (syncPuffer != 0) {
            syncPuffer = Math.sign(syncPuffer)==-1 ? Math.min(syncPuffer + friction * frameTimeDelta, 0) : Math.max(syncPuffer - friction * frameTimeDelta, 0);
          }

          // Cycle thwough the elements relative to the topViewportIndex
          // First: all elements that come before topViewportIndex
          for (var i = topViewportIndex-1; i > 0; i--) {
            let offset = data[i].offset = speed*(Math.abs(i-topViewportIndex+1)*-7);
            boxChildren[i].style.transform = `translateY(${offset+syncPuffer}px)`;
          }
          // Second: All elements that come after topViewportIndex
          for (let i = topViewportIndex+1; i < length; i++) {
            let offset = data[i].offset = speed*((i-topViewportIndex)*-7);
            boxChildren[i].style.transform = `translateY(${offset+syncPuffer}px)`;
          }
        }

        if (speed == 0) {
          isRunning = false;
          return;
        }
      }

      document.addEventListener("wheel", move);

    </script>
  </body>
</html>
